<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ViajeJuntos - Planificador HTML</title>
    <!-- Tailwind CSS para estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Fix Robusto para Móviles - ESTRATEGIA DE SCROLL NATIVO */
        html { 
            /* Permitir comportamiento estándar */
            min-height: 100%;
        }
        body { 
            font-family: 'Inter', sans-serif; 
            /* Quitamos fixed y overflow hidden para permitir scroll natural del navegador */
            min-height: 100%;
            background-color: #f9fafb; /* Coincide con bg-gray-50 */
        }
        
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Ocultar scrollbar visualmente pero permitir scroll */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>

<body class="text-gray-800">

    <!-- Vista de Carga / Error de Configuración -->
    <div id="loading-view" class="fixed inset-0 bg-blue-50 flex items-center justify-center z-[60]">
        <div id="loading-content" class="text-center p-4">
            <div class="text-indigo-600 font-semibold animate-pulse text-xl">Cargando ViajeJuntos...</div>
            <p class="text-sm text-gray-400 mt-2">Iniciando aplicación...</p>
        </div>
    </div>

    <!-- Vista de Inicio (Login/Unirse) -->
    <!-- Z-Index alto para tapar todo. Scroll propio por si el teclado tapa campos -->
    <div id="home-view" class="hidden fixed inset-0 z-50 bg-gradient-to-br from-blue-400 to-indigo-600 overflow-y-auto scroll-touch">
        <div class="min-h-full flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full fade-in my-auto">
                <div class="text-center mb-8">
                    <div class="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path></svg>
                    </div>
                    <h1 class="text-3xl font-bold text-gray-800">ViajeJuntos</h1>
                    <p class="text-gray-500 mt-2">Planifica tu próxima aventura.</p>
                    <div id="connection-status" class="mt-2 inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600">
                        <span class="w-2 h-2 rounded-full bg-gray-400"></span> Verificando conexión...
                    </div>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tu Nombre <span class="text-red-500">*</span></label>
                        <input type="text" id="username-input" placeholder="ej. Juan Pérez" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition bg-yellow-50">
                    </div>

                    <div>
                        <label id="home-label" class="block text-sm font-medium text-gray-700 mb-1">Nombre del Viaje / Código</label>
                        <input type="text" id="trip-id-input" placeholder="ej. eurotrip-2025" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition">
                    </div>
                    
                    <button id="btn-join-create" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition transform hover:scale-[1.02]">
                        Comenzar / Crear Viaje
                    </button>

                    <div class="text-center mt-4">
                        <p class="text-xs text-gray-400">
                            Si estás en modo Offline, recuerda guardar (descargar) tu archivo .json antes de salir.
                        </p>
                    </div>

                    <div class="relative mt-8 pt-6 border-t border-gray-100">
                        <div class="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white px-2 text-xs text-gray-400 whitespace-nowrap">
                            O CARGA UN JSON EXISTENTE
                        </div>
                        <div class="flex justify-center">
                            <label class="cursor-pointer flex items-center gap-2 px-4 py-2 bg-gray-50 hover:bg-gray-100 text-gray-600 rounded-lg border border-gray-200 transition text-sm font-medium">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                                Subir archivo .json
                                <input type="file" id="file-import-home" accept=".json" class="hidden">
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Vista Principal de la App -->
    <!-- CAMBIO: Usamos min-h-screen en lugar de h-full y fixed para permitir scroll nativo -->
    <div id="app-view" class="hidden flex-col min-h-screen w-full fade-in">
        
        <!-- Navbar: Sticky para que se quede arriba al scrollear la página -->
        <header class="bg-white shadow-sm border-b border-gray-200 z-30 sticky top-0">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex justify-between items-center">
                <div class="flex items-center gap-3 overflow-hidden">
                    <div class="bg-indigo-100 p-2 rounded-lg flex-shrink-0">
                        <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path></svg>
                    </div>
                    <div class="min-w-0">
                        <h1 id="trip-title" class="text-xl font-bold text-gray-800 truncate">Cargando...</h1>
                        <div class="flex flex-col sm:flex-row sm:items-center gap-0 sm:gap-3 text-xs text-gray-500">
                             <p class="flex items-center gap-1 truncate">
                                Código: <span id="display-trip-code" class="font-mono bg-gray-100 px-1 rounded font-bold">...</span>
                            </p>
                            <p id="meta-info" class="hidden sm:block text-gray-400 italic border-l pl-3 border-gray-300 truncate">
                                <!-- Info de edición se inyecta aquí -->
                            </p>
                        </div>
                    </div>
                </div>

                <div class="flex items-center gap-2 flex-shrink-0">
                    <label class="cursor-pointer p-2 text-gray-600 hover:bg-gray-100 rounded-full" title="Subir Archivo">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        <input type="file" id="file-import-app" accept=".json" class="hidden">
                    </label>
                    <button id="btn-export" class="p-2 text-gray-600 hover:bg-gray-100 rounded-full" title="Guardar Archivo">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                    </button>
                    <button id="btn-logout" class="p-2 text-red-500 hover:bg-red-50 rounded-full" title="Salir">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    </button>
                </div>
            </div>
            <!-- Mobile Meta Info -->
            <div id="meta-info-mobile" class="sm:hidden px-4 pb-2 text-xs text-gray-400 italic text-center truncate bg-white border-b border-gray-200"></div>
        </header>

        <!-- Main: Quitamos overflow-y-auto. Dejamos que el contenido crezca naturalmente -->
        <main class="flex-1 w-full p-4 md:p-6 bg-gray-50">
             <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6 pb-20">
            
                <!-- Sidebar -->
                <div class="lg:col-span-4 xl:col-span-3 space-y-6">
                    <!-- Selector Fecha -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                            <svg class="w-5 h-5 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            Calendario
                        </h2>
                        <div class="space-y-2">
                            <input type="date" id="date-picker" class="w-full p-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                            
                            <div class="mt-4">
                                <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Días con planes</h3>
                                <div id="active-days-list" class="flex flex-wrap gap-2">
                                    <!-- Botones de días se inyectan aquí -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Stats -->
                    <div class="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl shadow-lg p-5 text-white">
                        <h3 class="font-semibold text-lg mb-1">Resumen del Viaje</h3>
                        <div class="mt-4 grid grid-cols-2 gap-4">
                            <div class="bg-white/10 rounded-lg p-3 backdrop-blur-sm">
                                <span id="stat-total-activities" class="block text-2xl font-bold">0</span>
                                <span class="text-xs opacity-80">Actividades</span>
                            </div>
                            <div class="bg-white/10 rounded-lg p-3 backdrop-blur-sm">
                                <span id="stat-total-days" class="block text-2xl font-bold">0</span>
                                <span class="text-xs opacity-80">Días Activos</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contenido Principal -->
                <div class="lg:col-span-8 xl:col-span-9 space-y-6">
                    <div class="flex items-center justify-between">
                        <h2 id="day-title" class="text-xl font-bold text-gray-800 flex items-center gap-2">
                            Itinerario...
                        </h2>
                    </div>

                    <div id="events-container" class="relative border-l-2 border-indigo-100 ml-3 space-y-6 pb-4 min-h-[100px]">
                        <!-- Eventos se inyectan aquí -->
                    </div>
                    
                    <!-- Botón Agregar (Estado inicial) -->
                    <button id="btn-show-add-form" class="w-full py-4 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 font-medium hover:border-indigo-500 hover:text-indigo-600 hover:bg-indigo-50 transition flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        <span id="text-add-btn">Agregar Actividad</span>
                    </button>

                    <!-- Formulario Agregar/Editar (Oculto por defecto) -->
                    <div id="add-event-form" class="hidden bg-white rounded-xl shadow-md border border-indigo-100 p-6 fade-in">
                        <div class="flex justify-between items-center mb-4">
                            <h3 id="form-title" class="font-bold text-gray-800">Nueva Actividad</h3>
                            <button id="btn-close-form" class="text-gray-400 hover:text-gray-600">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                        <form id="form-new-event" class="space-y-4">
                            <input type="hidden" name="eventId" value=""> <!-- ID oculto para edición -->
                            
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                <!-- Columna de Tiempos -->
                                <div class="sm:col-span-1 grid grid-cols-2 sm:grid-cols-1 gap-2">
                                    <div>
                                        <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Inicio</label>
                                        <input type="time" name="time" required value="09:00" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Fin <span class="text-gray-300 font-normal lowercase">(opc)</span></label>
                                        <input type="time" name="endTime" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-gray-600">
                                    </div>
                                </div>
                                
                                <!-- Columna de Datos Principales -->
                                <div class="sm:col-span-2 space-y-4">
                                    <div>
                                        <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Actividad</label>
                                        <input type="text" name="title" required placeholder="Ej. Visita al Museo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Ubicación</label>
                                        <input type="text" name="location" required placeholder="Ej. Torre Eiffel, París" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Notas</label>
                                <textarea name="notes" rows="2" placeholder="Detalles..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-sm"></textarea>
                            </div>
                            <div class="flex justify-end gap-3 pt-2">
                                <button type="button" id="btn-cancel-form" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg font-medium transition">Cancelar</button>
                                <button type="submit" id="btn-submit-form" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium shadow-md transition flex items-center gap-2">
                                    Guardar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-[70]">
        <span id="toast-message">Mensaje</span>
    </div>

    <!-- Scripts: Firebase & App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // =========================================================================
        // CONFIGURACIÓN DE FIREBASE
        // =========================================================================
        const manualConfig = {
            apiKey: "TU_API_KEY_AQUI", // Deja esto como está para probar el modo Offline
            authDomain: "TU_PROYECTO.firebaseapp.com",
            projectId: "TU_PROYECTO_ID",
            storageBucket: "TU_PROYECTO.firebasestorage.app",
            messagingSenderId: "NUMERO",
            appId: "TU_APP_ID"
        };

        // --- Estado Global ---
        let state = {
            user: null,
            username: "",
            activeTripId: null,
            isOffline: false, // Bandera para modo offline
            tripData: { 
                name: "Mi Viaje", 
                events: [], 
                lastUpdated: 0,
                lastUpdatedBy: null 
            },
            selectedDate: new Date().toISOString().split('T')[0],
            isJoinMode: true,
            editingEventId: null
        };

        // --- Referencias DOM ---
        const views = {
            loading: document.getElementById('loading-view'),
            home: document.getElementById('home-view'),
            app: document.getElementById('app-view')
        };
        const els = {
            usernameInput: document.getElementById('username-input'),
            homeLabel: document.getElementById('home-label'),
            tripInput: document.getElementById('trip-id-input'),
            btnJoinCreate: document.getElementById('btn-join-create'),
            fileImportHome: document.getElementById('file-import-home'),
            
            tripTitle: document.getElementById('trip-title'),
            displayTripCode: document.getElementById('display-trip-code'),
            metaInfo: document.getElementById('meta-info'),
            metaInfoMobile: document.getElementById('meta-info-mobile'),
            connectionStatus: document.getElementById('connection-status'),
            
            fileImportApp: document.getElementById('file-import-app'),
            btnExport: document.getElementById('btn-export'),
            btnLogout: document.getElementById('btn-logout'),
            
            datePicker: document.getElementById('date-picker'),
            activeDaysList: document.getElementById('active-days-list'),
            statTotalActivities: document.getElementById('stat-total-activities'),
            statTotalDays: document.getElementById('stat-total-days'),
            
            dayTitle: document.getElementById('day-title'),
            eventsContainer: document.getElementById('events-container'),
            
            btnShowAddForm: document.getElementById('btn-show-add-form'),
            textAddBtn: document.getElementById('text-add-btn'),
            
            addEventForm: document.getElementById('add-event-form'),
            formTitle: document.getElementById('form-title'),
            btnSubmitForm: document.getElementById('btn-submit-form'),
            btnCloseForm: document.getElementById('btn-close-form'),
            btnCancelForm: document.getElementById('btn-cancel-form'),
            formNewEvent: document.getElementById('form-new-event'),
            
            toast: document.getElementById('toast'),
            toastMsg: document.getElementById('toast-message')
        };

        // --- Lógica de Inicialización ---
        let fb = null;
        let firebaseConfig = null;
        let appId = 'viaje-local';

        // Intentar obtener config de IA o Manual
        if (typeof __firebase_config !== 'undefined' && __firebase_config) {
            try {
                firebaseConfig = JSON.parse(__firebase_config);
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            } catch (e) {}
        } else {
            firebaseConfig = manualConfig;
        }

        const initSystem = async () => {
            // Verificar si tenemos config válida
            const hasValidConfig = firebaseConfig && firebaseConfig.apiKey && firebaseConfig.apiKey !== "TU_API_KEY_AQUI";

            if (hasValidConfig) {
                try {
                    const app = initializeApp(firebaseConfig);
                    const auth = getAuth(app);
                    const db = getFirestore(app);
                    fb = { auth, db };
                    
                    // Iniciar Auth Firebase
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                    
                    // Listener de Auth real
                    onAuthStateChanged(auth, (u) => {
                        state.user = u;
                        state.isOffline = false;
                        updateConnectionUI(true);
                        views.loading.classList.add('hidden');
                        if (u) switchView('home');
                    });
                } catch (err) {
                    console.error("Fallo conexión Firebase, pasando a modo Offline", err);
                    activateOfflineMode();
                }
            } else {
                console.log("No hay config Firebase, iniciando modo Offline");
                activateOfflineMode();
            }
        };

        const activateOfflineMode = () => {
            state.isOffline = true;
            // Usuario Falso para modo offline
            state.user = { uid: 'offline-user-' + Math.floor(Math.random()*1000) };
            updateConnectionUI(false);
            views.loading.classList.add('hidden');
            switchView('home');
        };

        const updateConnectionUI = (isOnline) => {
            if (isOnline) {
                els.connectionStatus.innerHTML = `<span class="w-2 h-2 rounded-full bg-green-500"></span> Conectado a Nube`;
                els.connectionStatus.className = "mt-2 inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium bg-green-50 text-green-700";
            } else {
                els.connectionStatus.innerHTML = `<span class="w-2 h-2 rounded-full bg-orange-400"></span> Modo Local (Offline)`;
                els.connectionStatus.className = "mt-2 inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium bg-orange-50 text-orange-700 border border-orange-100";
            }
        };

        // --- Utilidades ---
        const showToast = (msg) => {
            els.toastMsg.textContent = msg;
            els.toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => {
                els.toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        };

        const formatDate = (dateStr) => {
            const d = new Date(dateStr + 'T00:00:00');
            return d.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
        };
        
        const formatShortDate = (dateStr) => {
             const d = new Date(dateStr + 'T00:00:00');
             return d.toLocaleDateString('es-ES', { day: '2-digit', month: 'short' });
        };

        const formatMetaInfo = (meta) => {
            if (!meta || !meta.date) return 'Sin datos de edición';
            const date = new Date(meta.date);
            const userStr = meta.username ? meta.username : (meta.uid ? (meta.uid.startsWith('offline') ? 'Usuario Local' : `Usuario ${meta.uid.slice(0, 5)}`) : 'Desconocido');
            return `Editado por ${userStr} el ${date.toLocaleDateString()} a las ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
        };

        // --- Lógica de Vistas ---
        const switchView = (viewName) => {
            Object.values(views).forEach(el => el.classList.add('hidden'));
            views[viewName].classList.remove('hidden');
        };

        const resetForm = () => {
             els.formNewEvent.reset();
             els.formNewEvent.querySelector('[name="time"]').value = "09:00"; // Default
             state.editingEventId = null;
             els.formTitle.textContent = "Nueva Actividad";
             els.btnSubmitForm.textContent = "Guardar" + (state.isOffline ? " (Memoria)" : "");
             els.addEventForm.classList.add('hidden');
             els.btnShowAddForm.classList.remove('hidden');
        };

        const openEditForm = (event) => {
            state.editingEventId = event.id;
            const form = els.formNewEvent;
            form.querySelector('[name="time"]').value = event.time;
            form.querySelector('[name="endTime"]').value = event.endTime || "";
            form.querySelector('[name="title"]').value = event.title;
            form.querySelector('[name="location"]').value = event.location;
            form.querySelector('[name="notes"]').value = event.notes || "";
            
            els.formTitle.textContent = "Editar Actividad";
            els.btnSubmitForm.textContent = "Actualizar" + (state.isOffline ? " (Memoria)" : "");
            
            els.btnShowAddForm.classList.add('hidden');
            els.addEventForm.classList.remove('hidden');
        };

        // --- Renderizado ---
        const render = () => {
            // Actualizar inputs de control
            els.datePicker.value = state.selectedDate;
            els.displayTripCode.textContent = state.activeTripId || 'Local';
            els.tripTitle.textContent = state.tripData.name;
            
            // Meta Info
            const metaStr = formatMetaInfo(state.tripData.lastUpdatedBy);
            els.metaInfo.textContent = metaStr;
            els.metaInfoMobile.textContent = metaStr;
            
            // Stats
            const uniqueDays = [...new Set(state.tripData.events.map(e => e.date))];
            els.statTotalActivities.textContent = state.tripData.events.length;
            els.statTotalDays.textContent = uniqueDays.length;

            // Lista de días activos
            els.activeDaysList.innerHTML = '';
            const sortedDays = uniqueDays.sort();
            if (sortedDays.length === 0) {
                els.activeDaysList.innerHTML = '<span class="text-sm text-gray-400 italic">Sin eventos</span>';
            } else {
                sortedDays.forEach(date => {
                    const btn = document.createElement('button');
                    const isActive = date === state.selectedDate;
                    btn.className = `px-3 py-1 text-sm rounded-full transition ${isActive ? 'bg-indigo-600 text-white shadow-md' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`;
                    btn.textContent = formatShortDate(date);
                    btn.onclick = () => {
                        state.selectedDate = date;
                        render();
                    };
                    els.activeDaysList.appendChild(btn);
                });
            }

            // Título del Día
            els.dayTitle.textContent = `Itinerario para el ${formatDate(state.selectedDate)}`;
            els.textAddBtn.textContent = `Agregar Actividad para el ${formatShortDate(state.selectedDate)}`;

            // Lista de Eventos
            const dayEvents = state.tripData.events
                .filter(e => e.date === state.selectedDate)
                .sort((a, b) => a.time.localeCompare(b.time));
            
            els.eventsContainer.innerHTML = '';

            if (dayEvents.length === 0) {
                els.eventsContainer.innerHTML = `
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8 text-center">
                        <p class="text-gray-500">No hay planes para este día.</p>
                    </div>
                `;
            } else {
                dayEvents.forEach(event => {
                    // Links & Display logic (igual que antes)
                    const startDT = event.date.replace(/-/g, '') + 'T' + event.time.replace(/:/g, '') + '00';
                    let endDT;
                    if (event.endTime) {
                        endDT = event.date.replace(/-/g, '') + 'T' + event.endTime.replace(/:/g, '') + '00';
                    } else {
                        const hourNum = parseInt(event.time.split(':')[0]);
                        endDT = event.date.replace(/-/g, '') + 'T' + (hourNum + 1).toString().padStart(2,'0') + event.time.split(':')[1] + '00';
                    }
                    const calLink = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(event.title)}&dates=${startDT}/${endDT}&details=${encodeURIComponent(event.notes || '')}&location=${encodeURIComponent(event.location)}`;
                    const mapLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(event.location)}`;
                    const timeDisplay = event.endTime ? `${event.time} - ${event.endTime}` : event.time;

                    const el = document.createElement('div');
                    el.className = 'relative pl-8 group fade-in';
                    el.innerHTML = `
                        <div class="absolute -left-[9px] top-4 w-4 h-4 rounded-full border-2 border-white bg-indigo-500 shadow-sm z-10"></div>
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5 hover:shadow-md transition-shadow relative overflow-hidden">
                            <div class="flex flex-col sm:flex-row sm:items-start justify-between gap-4">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 text-indigo-600 font-bold mb-1">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                        ${timeDisplay}
                                    </div>
                                    <h3 class="text-lg font-bold text-gray-900 mb-1">${event.title}</h3>
                                    ${event.notes ? `<p class="text-gray-600 text-sm mb-3 bg-gray-50 p-2 rounded-lg inline-block max-w-full">${event.notes}</p>` : ''}
                                    
                                    <div class="flex flex-wrap items-center gap-3 mt-2">
                                        <a href="${mapLink}" target="_blank" class="inline-flex items-center gap-1.5 text-sm font-medium text-blue-600 hover:text-blue-800 hover:underline bg-blue-50 px-3 py-1.5 rounded-full transition">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                            ${event.location}
                                        </a>
                                        <a href="${calLink}" target="_blank" class="inline-flex items-center gap-1.5 text-sm font-medium text-green-600 hover:text-green-800 bg-green-50 px-3 py-1.5 rounded-full transition">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                            Añadir a Calendario
                                        </a>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2 self-start sm:self-center">
                                    <button data-id="${event.id}" class="btn-edit text-gray-400 hover:text-indigo-600 p-2 hover:bg-indigo-50 rounded-lg transition" title="Editar">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                    </button>
                                    <button data-id="${event.id}" class="btn-delete text-gray-400 hover:text-red-500 p-2 hover:bg-red-50 rounded-lg transition" title="Eliminar">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    els.eventsContainer.appendChild(el);
                });

                document.querySelectorAll('.btn-delete').forEach(btn => btn.addEventListener('click', (e) => deleteEvent(e.currentTarget.getAttribute('data-id'))));
                document.querySelectorAll('.btn-edit').forEach(btn => btn.addEventListener('click', (e) => {
                    const event = state.tripData.events.find(ev => ev.id === e.currentTarget.getAttribute('data-id'));
                    if (event) openEditForm(event);
                }));
            }
        };

        // --- Operaciones de Datos (Híbrido) ---
        
        const startListening = () => {
            if (state.isOffline) {
                // Modo Offline: Simplemente renderizar lo que hay en memoria
                // Si es un "Nuevo Viaje", inicializar vacío si no hay datos
                if (!state.tripData.name || state.tripData.name === "Mi Viaje") {
                    state.tripData = { 
                        name: "Nuevo Viaje Local", 
                        events: [], 
                        lastUpdated: Date.now(),
                        lastUpdatedBy: { uid: state.user.uid, username: state.username, date: Date.now() }
                    };
                }
                render();
                return;
            }

            // Modo Online: Firebase listener
            if (!state.activeTripId) return;
            const tripRef = doc(fb.db, 'artifacts', appId, 'public', 'data', 'trips', state.activeTripId);
            
            onSnapshot(tripRef, (snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.data();
                    state.tripData = data;
                    const dates = [...new Set(data.events.map(e => e.date))].sort();
                    const currentHasEvents = data.events.some(e => e.date === state.selectedDate);
                    if (!currentHasEvents && dates.length > 0 && !dates.includes(state.selectedDate)) {
                        state.selectedDate = dates[0];
                    }
                } else {
                    const now = Date.now();
                    const initialData = { 
                        name: "Nuevo Viaje", 
                        events: [], 
                        lastUpdated: now,
                        lastUpdatedBy: { uid: state.user.uid, username: state.username, date: now }
                    };
                    setDoc(tripRef, initialData);
                    state.tripData = initialData;
                }
                render();
            });
        };

        const updateTripMetadata = async (newEvents) => {
            const now = Date.now();
            const meta = { 
                uid: state.user.uid, 
                username: state.username || "Anónimo", 
                date: now 
            };
            
            // Actualizar estado local (siempre necesario para render instantáneo)
            state.tripData.events = newEvents;
            state.tripData.lastUpdated = now;
            state.tripData.lastUpdatedBy = meta;

            if (state.isOffline) {
                render();
                return;
            }

            // Si Online, guardar en DB
            const tripRef = doc(fb.db, 'artifacts', appId, 'public', 'data', 'trips', state.activeTripId);
            await updateDoc(tripRef, { events: newEvents, lastUpdated: now, lastUpdatedBy: meta });
        };

        const saveEvent = async (eventData) => {
            let updatedEvents;
            if (state.editingEventId) {
                updatedEvents = state.tripData.events.map(ev => {
                    if (ev.id === state.editingEventId) {
                        return { ...ev, ...eventData };
                    }
                    return ev;
                });
                showToast("Actividad actualizada " + (state.isOffline ? "(Local)" : ""));
            } else {
                const newEvent = {
                    id: crypto.randomUUID(),
                    date: state.selectedDate,
                    ...eventData,
                    addedBy: state.user.uid
                };
                updatedEvents = [...state.tripData.events, newEvent];
                showToast("Actividad agregada " + (state.isOffline ? "(Local)" : ""));
            }
            await updateTripMetadata(updatedEvents);
            resetForm();
        };

        const deleteEvent = async (id) => {
            if(!confirm("¿Eliminar esta actividad?")) return;
            const updatedEvents = state.tripData.events.filter(e => e.id !== id);
            await updateTripMetadata(updatedEvents);
            showToast("Actividad eliminada");
        };

        const handleImport = (file, isHome = false) => {
            if (!file) return;

            if (isHome) {
                const username = els.usernameInput.value.trim();
                if (!username) {
                    alert("Por favor ingresa tu nombre antes de cargar un archivo.");
                    els.fileImportHome.value = ''; 
                    els.usernameInput.focus();
                    return;
                }
                state.username = username;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    if (json.events && Array.isArray(json.events)) {
                        
                        // Lógica de importación
                        const now = Date.now();
                        const meta = { 
                            uid: state.user.uid, 
                            username: state.username || "Usuario Importador", 
                            date: now 
                        };
                        
                        const newData = {
                            name: json.name || "Viaje Importado",
                            events: json.events,
                            lastUpdated: now,
                            lastUpdatedBy: meta
                        };

                        if (state.isOffline) {
                            // En offline, simplemente reemplazamos la memoria
                            state.tripData = newData;
                            state.activeTripId = 'local-import-' + Math.floor(Math.random()*1000);
                        } else {
                            // En online, guardamos en DB
                            let targetId = state.activeTripId;
                            if (!targetId) {
                                if (els.tripInput.value.trim()) {
                                    targetId = els.tripInput.value.trim().replace(/[^a-zA-Z0-9-_]/g, '');
                                } else {
                                    targetId = `importado-${Math.floor(Math.random() * 10000)}`;
                                }
                            }
                            const tripRef = doc(fb.db, 'artifacts', appId, 'public', 'data', 'trips', targetId);
                            await setDoc(tripRef, newData, { merge: true });
                            state.activeTripId = targetId;
                        }

                        if (isHome) {
                            switchView('app');
                            startListening();
                        } else {
                            // Si importamos desde dentro de la app, forzamos render o reload
                            if(state.isOffline) render();
                        }
                        showToast("Itinerario cargado correctamente");
                    } else {
                        showToast("Error: JSON inválido");
                    }
                } catch (err) {
                    showToast("Error al leer archivo");
                    console.error(err);
                }
            };
            reader.readAsText(file);
        };

        // --- Event Listeners ---
        
        // Botón en Home
        
        els.btnJoinCreate.addEventListener('click', () => {
            const username = els.usernameInput.value.trim();
            if (!username) {
                showToast("Por favor ingresa tu nombre");
                els.usernameInput.focus();
                return;
            }
            state.username = username;

            const val = els.tripInput.value.trim();
            // En modo offline, permitimos entrar sin ID (creará uno local)
            // O con ID para "simular" un nombre
            if (val) {
                state.activeTripId = val.replace(/[^a-zA-Z0-9-_]/g, '');
            } else {
                state.activeTripId = null; // Creará "Nuevo Viaje Local"
            }
            
            switchView('app');
            startListening();
        });

        els.fileImportHome.addEventListener('change', (e) => handleImport(e.target.files[0], true));

        // Botones App
        els.btnLogout.addEventListener('click', () => {
            if(state.isOffline && !confirm("Estás en modo Offline. Si sales sin guardar el archivo JSON perderás los cambios. ¿Salir?")) {
                return;
            }
            state.activeTripId = null;
            state.tripData = { name: "Mi Viaje", events: [], lastUpdated: 0 };
            state.username = ""; 
            els.usernameInput.value = ""; 
            els.tripInput.value = "";
            switchView('home');
        });

        els.datePicker.addEventListener('change', (e) => {
            state.selectedDate = e.target.value;
            render();
        });

        els.btnShowAddForm.addEventListener('click', () => {
            resetForm(); 
            els.btnShowAddForm.classList.add('hidden');
            els.addEventForm.classList.remove('hidden');
        });

        els.btnCancelForm.addEventListener('click', () => resetForm());
        els.btnCloseForm.addEventListener('click', () => resetForm());

        els.formNewEvent.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            saveEvent({
                time: formData.get('time'),
                endTime: formData.get('endTime'), 
                title: formData.get('title'),
                location: formData.get('location'),
                notes: formData.get('notes')
            });
        });

        els.btnExport.addEventListener('click', () => {
            const dataStr = JSON.stringify(state.tripData, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = `itinerario-${state.activeTripId || 'local'}.json`;
            link.click();
        });

        els.fileImportApp.addEventListener('change', (e) => handleImport(e.target.files[0], false));

        // Arrancar
        initSystem();

    </script>
</body>
</html>




